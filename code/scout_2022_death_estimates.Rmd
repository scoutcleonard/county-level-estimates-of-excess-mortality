---
title: "Estimate Poisson Predicated Deaths for 2022"
author: "Scout Leonard"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries 

```{r}
#install and load librarian package if needed 
if (!require(librarian)) {
  install.packages("librarian")
  library(librarian)
}

# load packages
shelf(tidyr,
      dplyr,
      ggplot2,
      data.table,
      stringr,
      sandwich,
      here,
      usmap)

#source functions
##misc functions
source(here("code/ackley_funs.R"))
##This is a modification of the add_pi function in ciTools which uses robust standard errors
##See https://cran.r-project.org/web/packages/ciTools/vignettes/ciTools-glm-vignette.html
source(here("code/sim_glm_robust_fun.R")) 
```

# Import Data

```{r}
dat <- read.csv(here('raw_data/acm_2011-2022.csv')) %>% 
  mutate(county_code = if_else(str_length(county_code) == 4,
                        str_c("0", as.character(county_code)),
                        as.character(county_code)))
```

### Conduct Edits 

```{r}
base_year <- 1998

dat_edit <- dat %>% 
  filter(year >= 2011, !is.na(county)) %>%
  mutate(time = year - base_year, #Normalize time to 1999 = 1
         time_orig_vals = time)
```

```{r}
#take the mean population over the 8 yrs represented 
dat_500 <- dat_edit %>% 
  group_by(county_code) %>% 
  summarize(mean_pop = mean(population)) %>% 
  ungroup()

#subset the top 500 most populous counties 
dat_500 <- dat_500[order(dat_500$mean_pop, decreasing = TRUE),]
dat_500 <- dat_500[1:500,]
dat_edit <- subset(dat_edit, county_code %in% dat_500$county_code)

#check to see that 500 unique counties are represented
num_counties_dat_500 <- length(unique(dat_edit$county_code))
num_counties_dat_500
```

```{r}
#arrange/order counties by name and year
dat_est <- dat_edit %>% arrange(county, year)

dat_est <- dat_est %>% filter(year < 2022)
```

# Model

## Write Model

Fit a generalized linear model to the county-level all cause mortality data: 

```{r}
fit <- glm(deaths ~ offset(log(exposure)) +
             death_rate_lag1 +
             time +
             time*factor(county_code),
           family = quasipoisson(link = "log"),
           data = dat_est)
```

## Save Output

Save output to `rda` directory of repo (this was added to the .gitignore):

```{r}
if(1 == 1){
  save(fit, file = here('rda/estimated_poisson_glm_parameters.rda'))
}
```

## Compare Cluster-Robust Errors

```{r}
vmat_rob <- vcovCL(fit, cluster = ~ county_code)
clust_ses <- sqrt(diag(vmat_rob)) #produces warning: NAs produced 

#save to rda directory
if(1 == 1){
  save(clust_ses, file = here('rda/estimated_poisson_glm_ses.rda'))
}
```

## Predict

```{r}
dat_est <- dat_est %>%
  mutate(fitted_deaths_all_yrs = exp(predict.glm(fit, dat_est)),
         fitted_death_rate_all_yrs = fitted_deaths_all_yrs / (population / 1000))
```

# EDA

```{r}
years_list <- unique(dat_est$year)

dat_est <- dat_est %>% 
  rename(fips = "county_code")

plot_by_year <- function(dat_est, year) {
  
  #filter data by year
  dat_est_year <- dat_est %>% 
    filter(year == year)
  
  #plot choropleth map
  plot_usmap(data = dat_est,
             regions = "counties",
             values = "fitted_death_rate_all_yrs",
             size = 0.1) + 
    labs(title = paste0("Predicted Mortality Rate:\n 500 Most Populous Counties in ",
                        year)) +
    theme(legend.position = "bottom")
  
  #save image
  ggsave(filename = here(paste0("output/viz/fitted_death_500_maps_", year, ".png")),
         dpi = 300,
         width = 6,
         height = 6,
         bg = "white")
}

for (i in 1:length(years_list)) {
  plot_by_year(dat_est = dat_est, year = years_list[i])
}

#test function
plot_by_year(dat_est = dat_est, year = 2018)
```

